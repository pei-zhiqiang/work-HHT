# V2验配报文协议v0.4.x



## 写入 主机-->从机

```
           /------------/------------/------------/------------/------------/------------/------------/-----------/
         /    帧头    /   帧类型    /   功能码   / 寄存器地址  /  数据长度  /   变长数据   /  CRC16_L   /  CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   /    1Byte   /   2Bytes   /   2Bytes   /     ...    /    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/------------/------------/
 /**************C******************R*******************C***********************/
PS：
小端模式：低8位在前
帧长最小为：11Bytes
总帧长为：10Bytes + 数据长度
```



### 回复写入 从机-->主机

```
           /------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   / ACK RESULT /
       /------------/------------/------------/------------/
     /   2Bytes   /    1Byte   /    1Byte   /   1Bytes   /
   /------------/------------/------------/------------/
PS：
帧长固定为：5Bytes 
ACK RESULT：1Byte 16进制0x01
```

## 读取 主机-->从机

```
           /------------/------------/------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   / 寄存器地址  /  CRC16_L   /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x04 /   2Bytes   /   1Byte    /    1Byte   /
   /------------/------------/------------/------------/------------/------------/
 /******C************R************C******************/ 
PS：
小端模式：低8位在前
帧长固定为：8Bytes
```

### 回复读取 从机-->主机

```
           /------------/------------/------------/------------/------------/------------/------------/
         /    帧头    /   帧类型   /   功能码    /  数据长度  /   变长数据  /  CRC16_L   /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   /    1Byte   /   2Bytes   /     ...    /    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/------------/
 /*************C******************R*******************C***********/
PS：
小端模式：低8位在前
帧长最短为：9Bytes
总帧长为：8Bytes + 数据长度
```



| 字段     | 数值                | 描述                                  |
| -------- | ------------------- | ------------------------------------- |
| 帧头     | 0x7A 0x55/0x75 0xAA | 代表由主机发/代表从机回复             |
| 帧类型   | 0xA5/0x5A           | 长帧（主机写命令）/短帧（主机读命令） |
| 数据长度 | 可变                | ==依附长帧类型存在==                  |
| 变长数据 | 可变                | ==依附长帧类型存在==                  |
| ACK RESULT | 0x01 | 为1时设置下发数据正常，其他操作失败 |

| 功能码 | 描述     |
| ------ | -------- |
| 0x03   | 设置参数 |
| 0x04   | 请求参数 |



| 寄存器地址（16进制） | 描述                 | 可写或可读数值                                               | 数值范围                                                     | 字节数                              | 读写权限 |
| -------------------- | -------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ----------------------------------- | -------- |
| 0x0000               | 固件版本             | int16                                                        | 数值范围：0x0000 - 0xFFFF ，数值含义：VER_MAJOR + VER_MINOR + VER_REVISION，VER_MAJOR 占用高字节，VER_MINOR 占用低字节的的高4位，VER_REVISION占用低字节的低4位， **如0x0011表示：VER_MAJOR 为0，VER_MINOR 为1，VER_REVISION为1合并起来就是v0.1.1** | 2Byte                               | R        |
| 0x0001               | 调节左右耳VC参数     | int8[2]                                                      | 数值范围 0 - 7 ，每加1增益3dB，传输左耳 + 右耳音量数值       | 2Bytes                              | RW       |
| 0x0002               | 调节左右耳EQ参数     | int8 left_imf_eq[4个子带]  int8 right_imf_eq[4个子带]        | 数值范围：±30dB，每个子带分别代表：0:1500 ~ 1:3000 - 2:6000 - 3:8000 | 8Bytes                              | RW       |
| 0x0003               | 调节左右耳WDRC参数   | int8 left_par[6 * 4个子带]  int8 right_par[6 * 4个子带]      | 数值范围：左耳第一个子带left_par[0] - left_par[5]分别代表：4组[0]:mute数值范围0 - 60 [1]:amp数值范围1 - 100 [2]:cmp数值范围2 - 119 [3]limit数值范围3 - 120.<br/>[4]`L_gain` – 设置低增益数值 [0 ~ 50].<br/>[5]`H_gain` – 设置高增益数值 [0 ~ 50]. | 48Bytes                             | RW       |
| 0x0004               | 调节AGC              | int8  UP_dB    int8  DOWN_dB                                 | `UP_dB` – 压缩阈值，高于此值时压缩限幅 [90 - 110].<br/>`DOWN_dB` – (静音阈值，低于此值时静音输出[1 - 10]，处于高低之间不做处理) | 2Bytes                              | RW       |
| 0x0005               | 调节DENOISE Level    | int8 denoise_level                                           | 降噪等级，1 - 3，1降噪等级最低，3降噪等级最高                | 1Bytes                              | RW       |
| 0x0006               | 启用功能             | int8 <br/>BF_FUNC_SEL               = 0x00<br/>DENOISE_FUNC_SEL          = 0x01<br/>MASK_EMD_FUNC_SEL         = 0x02<br/>EQ_FUNC_SEL               = 0X03<br/>VOL_FUNC_SEL              = 0x04<br/>WDRC_FUNC_SEL             = 0x05<br/>AGC_FUNC_SEL              = 0x06<br/>FUNC_MAX_SEL              = 0x07<br/>NO_FUNC_SEL               = 0x08<br/>TEST_FUNC_SEL             = 0x09<br/>MUTE_FUNC_SEL             = 0x0A<br/>FIR_FUNC_SEL              = 0x0B<br/>CALIBRATION_FUNC_SEL      = 0x0C | 算法全部启用情况下，BF的结果作为后续算法数据，只有在算法全开情况下可设置算法单独使能开关自由组合算法 | 1Byte                               | RW       |
| 0x0007               | 读取全部参数         | 固件版本、算法版本、参数自动保存设置、电量、充电状态、左耳补偿（硬件）、右耳补偿（硬件）、前置放大系数（硬件）、EQ频段（硬件）、EQ频段增益（硬件）、MIC灵敏级、MIC补偿值、VC算法参数、BF指向、EQ算法参数、WDRC算法参数、AGC算法参数、DENOISE等级、FIR算法参数、AEC算法参数、启用功能、BF使能状态、DENOISE使能状态、EMD使能状态、EQ使能状态、VC使能状态、WDRC使能状态、AGC使能状态、FIR使能状态、AEC使能状态、BF默认MIC、WDRC平滑系数（int16[4] 4个子带平滑系数 * 100的值）、WDRC Atk Rsl参数（int16 Atk，int16 Rsl，返回值放大了1000倍）、AGC Atk Rsl参数（int16 Atk，int16 Rsl，返回值放大了1000倍）、子带能量（int8[4]）、时域能量（int8） |                                                              | 最大125 + FIR 66Bytes + AEC 3 Bytes | R        |
| 0x0008               | 启动固件升级         | int8 写0 代表固件下载至下载分区，写1代表固件下载至出厂分区，写2代表固件下载至boot分区 | 0或者1或者2                                                  | 1Byte                               | W        |
| 0x0009               | 退出固件升级         | int8 为0下次重启自动更新固件，写1立即重启更新固件            | 0或者1                                                       | 1Byte                               | W        |
| 0x000A               | 电量信息             | int16 数据放大100倍给主机                                    | 从机提供放大100倍的电量数据给主机，范围：0-10000             | 2Bytes                              | R        |
| 0x000B               | 电池充电状态         | int8 为1时充电中， 为0时未充电                               | 0或者1                                                       | 1Byte                               | R        |
| 0x000C               | BF入射角度设置       | int16 数值范围：0 - 359°                                     | 数值范围：0 - 359° （代表四个方向权重选项，分别为0，90，180，270（0，1，2，3）。当音频从90度水平入射时，选择90度选项即可 | 2Bytes                              | RW       |
| 0x000D               | 左耳音量补偿         | int8 1Byte用于左耳听力单独补偿                               | 0-100                                                        | 1Byte                               | RW       |
| 0x000E               | 右耳音量补偿         | int8 1Byte用于右耳听力单独补偿                               | 0-100                                                        | 1Byte                               | RW       |
| 0x000F               | 前置放大系数         | float 4Byte                                                  | 1.0-100.0                                                    | 4Bytes                              | RW       |
| 0x0010               | EQ均衡器调节         | int16 eq[5] int8 eq_gain[5]                                  | 此参数仅适用于WM8978版本，*硬件EQ频率参数范围：* **eq[0]：** 80Hz、105Hz、135Hz、175Hz **eq[1]：** 230Hz、300Hz、385Hz、500Hz **eq[2]：** 650Hz、850Hz、1.1kHz、1.4kHz **eq[3]：** 1.8kHz、2.4kHz、3.2kHz、4.1kHz **eq[4]：** 5.3kHz、6.9kHz、9kHz、11.7kHz  *EQ频率对应增益参数范围：* **eq_gain[0] - [4]：** 为0时+12dB，数值每+1，增益减小1dB，最小-12dB | 15Bytes                             | RW       |
| 0x0011               | 听力曲线             | int8 left_ref_min_gain[6] int8 right_ref_min_gain[6] int8 left_ref_max_gain[6] int8 right_ref_max_gain[6] | ==left_ref_min_gain 用于左耳听力曲线测量结果（最低可听dB值），right_ref_min_gain用于右耳听力曲线测量结果，left_ref_max_gain 用于左耳听力曲线测量结果（最大可听dB值，即不舒适dB值），right_ref_max_gain用于右耳听力曲线测量结果（dB值 范围：1 - 100）==*频率范围：* **[0]：**250Hz **[1]：** 750Hz **[2]：** 1.5kHz  **[3]：** 3kHz  **[4]：** 5kHz、**[5]：** 8kHz | 24Bytes                             | RW       |
| 0x0012               | 听力测试             | int16 test_hz int8 test_gain int8 test_channel               | *6段测试频率：* **250Hz** **500Hz** **1kHz** **2kHz** **4kHz** **8kHz**，*当前频率下增益：* **0-100**，*测试通道：* **0**为左耳，**1**为右耳，==注意本功能的启用依赖寄存器0x0006，设置为8以启用测试模式==，当听力功能测试启用，通过设置本寄存器的频率，增益参数，通道号，辅听盒将播放指定频率声音 | 4Bytes                              | RW       |
| 0x0013               | AUTO_EQ微调          | int8 left_eq_gain[6] int8 right_eq_gain[6]                   | EQ微调用于听力曲线下发后，对自动计算的EQ数值进行二次调整，数值范围(-100至+100)，分别对应 *频率范围：* **[0]：**250Hz **[1]：** 750Hz **[2]：** 1.5kHz  **[3]：** 3kHz  **[4]：** 5kHz、**[5]：** 8kHz 的EQ数值， **注意如需调整此参数，应先读取后再进行修改操作** | 12Bytes                             | RW       |
| 0x0014               | EQ_EN                | int8 eq_en                                                   | EQ使能开关，为0时关闭EQ调节，为1时开启EQ调节                 | 1Byte                               | RW       |
| 0x0015               | WDRC_EN              | int8 wdrc_en                                                 | WDRC使能开关，为0时关闭WDRC调节，为1时开启WDRC调节           | 1Byte                               | RW       |
| 0x0023               | BF_EN                | int8 bf_en                                                   | BF算法使能开关，为0时关闭BF调节，为1时开启WDRC调节           | 1Byte                               | RW       |
| 0x0024               | VC_EN                | int8 vc_en                                                   | VC算法使能开关，为0时关闭VC调节，为1时开启VC调节             | 1Byte                               | RW       |
| 0x0025               | DENOISE_EN           | int8 denoise                                                 | DENOISE算法使能开关，为0时关闭DENOISE调节，为1时开启DENOISE调节 | 1Byte                               | RW       |
| 0x0026               | AGC_EN               | int8 agc_en                                                  | AGC算法使能开关，为0时关闭AGC调节，为1时开启AGC调节          | 1Byte                               | RW       |
| 0x0027               | EMD_EN               | int8 emd_en                                                  | FFT与EMD算法切换，为0时FFT算法，1时FFT & EMD                 | 1Byte                               | RW       |
| 0x0028               | BF_MIC               | int8 mic_num                                                 | BF算法关闭时默认输入源（MIC0 - MIC3）数值范围： 0 - 3        | 1Byte                               | RW       |
| 0x0029               | MIC_SENSITIVITY      | int8 mic_sensitivity                                         | 设置MIC灵敏级，数值范围： -60 - 0dB                          | 1Byte                               | RW       |
| 0x002A               | MIC_COMPENSATION     | int8 mic_compensation                                        | 设置MIC补偿值，用于能量计算还原，数值范围：0 - 60dB          | 1Byte                               | RW       |
| 0x002B               | ALG_VER              | int16                                                        | 算法版本：数值范围：0x0000 - 0xFFFF ，数值含义：VER_MAJOR + VER_MINOR + VER_REVISION，VER_MAJOR 占用高字节，VER_MINOR 占用低字节的的高4位，VER_REVISION占用低字节的低4位， **如0x0011表示：VER_MAJOR 为0，VER_MINOR 为1，VER_REVISION为1合并起来就是v0.1.1** | 2Bytes                              | R        |
| 0x002C               | SPK_COMPENSATION     | int8 set_dB[6] int8 out_dB[6]                                | 设置：喇叭各频带补偿参数用于校准发声测听，set_dB[0]代表250Hz下的发声dB，数值范围[1 - 50]，out_dB[0]为250Hz实际从设备喇叭测得的dB值，数值范围[ 0 - 120 ]<br/>读取：返回6个字节，代表各频带增益数值即set - out的结果返回 | 写入12Bytes，读取6Bytes             | RW       |
| 0x002D               | FIR_EN               | int8 fir_en                                                  | FIR算法使能开关，为0时关闭FIR调节，为1时开启FIR调节          | 1Byte                               | RW       |
| 0x002E               | FIR算法参数          | int8 order   int16 Coeff[65]                                 | Order 阶数，数值范围1 - 64，Coeff 系数表，阶数 = 系数数目 - 1，最大支持64阶 | 最大66Bytes                         | RW       |
| 0x002F               | AEC_EN               | int8 aec_en                                                  | AEC算法使能开关，为0时关闭AEC调节，为1时开启AEC调节          | 1Byte                               | RW       |
| 0x0030               | AEC算法参数          | int16 level int8 order                                       | level 回声抑制等级数值范围：0 - 320，order滤波阶数数值范围：1 - 64 | 3Bytes                              | RW       |
| 0x0016               | 启动文件传输         | int8 enable or disable                                       | 为0终止文件传输，为1启动文件传输                             | 1Byte                               | W        |
| 0x0021               | 重置所有参数到默认值 | int8 reset_par                                               | 写1进行重置，写入成功设备会在回复主机完成后，执行重启恢复默认参数 | 1Byte                               | W        |
| 0x0022               | 保存参数设置         | int8 auto_save                                               | 自动保存功能：最高位写1时参数自动保存，写0手动保存；保存时机：其他7位设置保存时间如设置15，自动保存时间为15*5=75s间隔；**此参数自动保存功能设置0时立即检测参数变化，若有改动立即保存，若设置0x81，则每5s检测参数变化自动保存**，出厂默认为0，即需下发0触发保存参数 | 1Byte                               | RW       |

## 测试报文

### AGC参数

```
【发送】7A 55 A5 03 04 00 02 00 64 0A C2 E3
【接收】75 AA A5 03 01
```

### 启用WDRC功能

```
【发送】7a 55 A5 03 06 00 01 00 03 B8 69
【接收】75 AA A5 03 01
```

### 请求参数

```
 /*请求 全部参数*/
【发送】7A 55 5A 04 07 00 56 A4
```
### 启动升级

```
【发送】7A 55 A5 03 08 00 01 00 01 50 69
【接收】75 AA A5 03 01 
设置发送"test.bin+1024"
【发送】7A 55 A5 10 00 00 80 00 74 65 73 74 2E 62 69 6E 2B 31 30 32 34 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 E0 B4
【接收】75 AA A5 10 01
```

# V2固件升级报文协议

固件升级报文协议支持，固件下载，固件上载。

数据内容皆以字节流方式传输，即存在于报文的变长数据中


| 字段       | 数值                                 | 描述                                                         |
| ---------- | ------------------------------------ | ------------------------------------------------------------ |
| 帧头       | 0x7A 0x55/0x75 0xAA                  | 代表由主机发/代表从机回复                                    |
| 帧类型     | 0xA5/0x5A                            | 长帧（主机写命令）/短帧（主机读命令）                        |
| 功能码     | 0x10/0x11                            | 0x10用于主机对从机固件数据流及固件信息下发，0x11用于主机获取从机固件数据流及固件信息 |
| 数据包号   | 0x0000                               | 传递固件信息                                                 |
| 数据长度   | 128即16进制0x0080/1024即16进制0x0400 | 当为128时：固件数据传输长度固定为128Bytes，即固定为0x00 80，注意发送时大小端问题，**80先传**;当为1024时：固件数据传输长度固定为1024Bytes，即固定为0x04 00，注意发送时大小端问题，**00先传**; |
| 固件信息   | "固件名+固件大小"                    | 固件名和固件大小以字符串形式给出，两者使用`+`号分割，固件名最大占用64Bytes，总128Bytes占用，**不足以0x00填充** |
| ACK RESULT | 0x01/0x02/0x03/04                    | 为1时设置固件信息正常，为2时下发固件数据正常，为3时下发固件结束帧正常，为4时操作失败 |








```sequence

主机->从机: 启动固件升级（设置）

从机-->主机: 从机回复OK进入升级状态

Note left of 主机: 主机检测固件名和大小信息(最大占用128Bytes,不足以0x00补齐,格式为"frimwareV1.0.bin+1024")
主机->从机: 发送固件信息

Note left of 从机: 从机检测固件名及大小信息
从机-->主机: 回复OK进入升级状态，回复其他则自动退出升级

主机->从机: 分包发送固件数据流
从机-->主机: 回复OK本包数据验证OK

主机->从机: 发送传输结束
从机-->主机: 回复OK

Note left of 主机: 设置0下次重启自动更新固件，写1立即重启更新固件
主机->从机: 退出固件升级（设置）
从机-->主机: 回复OK
```





### 写入 主机-->从机 设置固件大小

```
           /------------/------------/------------/------------/------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   /  数据包号  /   数据长度  /   固件信息  /  CRC16_L   /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x10 /2Bytes 00 00/   2Bytes   /  128Bytes  /    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/------------/------------/
 /**************C******************R*******************C***********************/
PS：
小端模式：低8位在前
总帧长为：138Bytes
```

#### 从机-->回复

```
           /------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   / ACK RESULT /
       /------------/------------/------------/------------/
     /   2Bytes   /    1Byte   /    1Byte   /   1Bytes   /
   /------------/------------/------------/------------/
PS：
帧长固定为：5Bytes 
ACK RESULT：1Byte 16进制0x01
```

### 写入 主机-->从机 传输固件数据流

```
           /------------/------------/------------/------------/------------/------------/------------/-----------/
         /    帧头    /   帧类型    /   功能码   /   数据包号  /  数据长度  /   固件数据  /  CRC16_L   /  CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x10 /   2Bytes   /   2Bytes   /     ...    /    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/------------/------------/
 /**************C******************R*******************C***********************/
PS：
小端模式：低8位在前
帧长最小为：138Bytes
帧长最大为：1034Bytes
```

#### 从机-->回复

```
           /------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   / ACK RESULT /
       /------------/------------/------------/------------/
     /   2Bytes   /    1Byte   /    1Byte   /   1Bytes   /
   /------------/------------/------------/------------/
PS：
帧长固定为：5Bytes 
ACK RESULT：1Byte 16进制0x01
```

### 写入 主机-->从机 传输结束

```
           /------------/------------/------------/------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   /   数据包号  /  数据长度  /  CRC16_L   /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x10 /2Bytes FF FF/2Bytes 00 00/    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/------------/
 /**************C******************R*******************C**********/
PS：
小端模式：低8位在前
总帧长为：10Bytes
```
#### 从机-->回复

```
           /------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   / ACK RESULT /
       /------------/------------/------------/------------/
     /   2Bytes   /    1Byte   /    1Byte   /   1Bytes   /
   /------------/------------/------------/------------/
PS：
帧长固定为：5Bytes 
ACK RESULT：1Byte 16进制0x02
```

**主机收到从机的应答后应使用0x03功能码设置从机退出升级状态，指定更新时刻，否则从机将默认下次重启自动使用更新后的固件。**

### 读取 主机-->从机 读取从机固件信息

```
           /------------/------------/------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   /   数据包号  /  CRC16_L   /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x11 /2Bytes 00 00/    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/
 /************C************R*************C***********/
PS：
小端模式：低8位在前
总帧长为：8Bytes
```

#### 回复读取 从机-->主机

```
           /------------/------------/------------/------------/------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   /   数据包号  /  数据长度  /   固件信息  /  CRC16_L  /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x11 /2Bytes 00 00/   2Bytes   /  128Bytes  /    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/------------/------------/
 /**************C******************R*******************C***********************/
PS：
小端模式：低8位在前
总帧长为：138Bytes
```



### 读取 主机-->从机 读取从机固件数据

- 主机通过发送读取固件数据起始帧

  - 从机回复固件数据流
  - 主机回复数据验证结果
  - 数据发送完毕？从机发送结束帧，主机应答OK。

  

主机发送读取固件数据流起始帧

```
           /------------/------------/------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   /   数据包号  /  CRC16_L   /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x11 /2Bytes FF FF/    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/
 /************C************R*************C***********/
PS：
小端模式：低8位在前
总帧长为：8Bytes
```

#### 回复读取 从机-->主机

```
           /------------/------------/------------/------------/------------/------------/------------/-----------/
         /    帧头    /   帧类型    /   功能码   /   数据包号  /  数据长度  /  固件数据  /   CRC16_L  /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x11 /   2Bytes   /   2Bytes   /     ...    /    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/------------/------------/
 /**************C******************R*******************C***********************/
PS：
小端模式：低8位在前
数据包号：起始从1开始
数据长度：可以是128或者1024
固件数据：本包固件数据
帧长最小为：138Bytes
帧长最大为：1034Bytes
```

#### 主机回复收到数据验证正确 主机-->从机

```
           /------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   / ACK RESULT /
       /------------/------------/------------/------------/
     /   2Bytes   /    1Byte   /    1Byte   /   1Bytes   /
   /------------/------------/------------/------------/
PS：
帧长固定为：5Bytes 
ACK RESULT：1Byte 16进制0x02
```

#### 从机发送结束帧 从机-->主机

```
           /------------/------------/------------/-------------/-------------/-------------/--------------/
         /    帧头    /   帧类型    /   功能码   /   数据包号   /   数据长度   /   CRC16_L   /    CRC16_H   /
       /------------/------------/------------/--------------/--------------/-------------/--------------/
     /   2Bytes   /   1Byte    / 1Byte 0x11 / 2Bytes FF FF / 2Bytes 00 00  /     1Byte   /     1Byte    /
   /------------/------------/------------/--------------/----------------/-------------/--------------/
 /**************C******************R*******************C**********/
PS：
小端模式：低8位在前
总帧长为：10Bytes
```



# V2文件传输协议

文件传输协议适用于传输各类文件如：音频流数据文件等。对比固件升级协议，本协议侧重于文件传输，文件上载要求时帧号0需传输上载文件名，传输期间停止设备的其他任务运行。

| 字段       | 数值                                 | 描述                                                         |
| ---------- | ------------------------------------ | ------------------------------------------------------------ |
| 帧头       | 0x7A 0x55/0x75 0xAA                  | 代表由主机发/代表从机回复                                    |
| 帧类型     | 0xA5/0x5A                            | 长帧（主机写命令）/短帧（主机读命令）                        |
| 功能码     | 0x20/0x21                            | 0x20用于主机对从机文件数据流及文件信息下发，0x21用于主机获取从机文件数据流及文件信息 |
| 数据包号   | 0x0000                               | 传递文件信息                                                 |
| 数据长度   | 128即16进制0x0080/1024即16进制0x0400 | 当为128时：文件数据传输长度固定为128Bytes，即固定为0x00 80，注意发送时大小端问题，**80先传**;当为1024时：文件数据传输长度固定为1024Bytes，即固定为0x04 00，注意发送时大小端问题，**00先传**; |
| 文件信息   | "文件名+文件大小"                    | 文件名和文件大小以字符串形式给出，两者使用`+`号分割，文件名最大占用64Bytes，总128Bytes占用，**不足以0x00填充** |
| ACK RESULT | 0x01/0x02/0x03/04                    | 为1时设置文件信息正常，为2时下发文件数据正常，为3时下发文件结束帧正常，为4时操作失败 |


```sequence

主机->从机: 启动文件传输（设置）

从机-->主机: 从机回复OK进入文件传输状态

Note left of 主机: 主机检测文件名和大小信息(最大占用128Bytes,不足以0x00补齐,格式为"Test_Audio.PCM+1024")
主机->从机: 发送文件信息

Note left of 从机: 从机检测文件名及大小信息
从机-->主机: 回复OK进入文件传输状态，回复其他则自动退出文件传输

主机->从机: 分包发送文件数据流
从机-->主机: 回复OK本包数据验证OK

主机->从机: 发送传输结束
从机-->主机: 回复OK

主机->从机: 退出文件传输（设置）
从机-->主机: 回复OK
```










### 写入 主机-->从机 设置文件大小

```
           /------------/------------/------------/------------/------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   /  数据包号  /   数据长度  /   固件信息  /  CRC16_L   /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x10 /2Bytes 00 00/   2Bytes   /  128Bytes  /    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/------------/------------/
 /**************C******************R*******************C***********************/
PS：
小端模式：低8位在前
总帧长为：138Bytes
```

#### 从机-->回复

```
           /------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   / ACK RESULT /
       /------------/------------/------------/------------/
     /   2Bytes   /    1Byte   /    1Byte   /   1Bytes   /
   /------------/------------/------------/------------/
PS：
帧长固定为：5Bytes 
ACK RESULT：1Byte 16进制0x01
```

### 写入 主机-->从机 传输文件数据流

```
           /------------/------------/------------/------------/------------/------------/------------/-----------/
         /    帧头    /   帧类型    /   功能码   /   数据包号  /  数据长度  /   固件数据  /  CRC16_L   /  CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x10 /   2Bytes   /   2Bytes   /     ...    /    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/------------/------------/
 /**************C******************R*******************C***********************/
PS：
小端模式：低8位在前
帧长最小为：138Bytes
帧长最大为：1034Bytes
```

#### 从机-->回复

```
           /------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   / ACK RESULT /
       /------------/------------/------------/------------/
     /   2Bytes   /    1Byte   /    1Byte   /   1Bytes   /
   /------------/------------/------------/------------/
PS：
帧长固定为：5Bytes 
ACK RESULT：1Byte 16进制0x01
```

### 写入 主机-->从机 传输结束

```
           /------------/------------/------------/------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   /   数据包号  /  数据长度  /  CRC16_L   /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x10 /2Bytes FF FF/2Bytes 00 00/    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/------------/
 /**************C******************R*******************C**********/
PS：
小端模式：低8位在前
总帧长为：10Bytes
```
#### 从机-->回复

```
           /------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   / ACK RESULT /
       /------------/------------/------------/------------/
     /   2Bytes   /    1Byte   /    1Byte   /   1Bytes   /
   /------------/------------/------------/------------/
PS：
帧长固定为：5Bytes 
ACK RESULT：1Byte 16进制0x02
```

**主机收到从机的应答后应使用0x03功能码设置从机退出文件传输状态，否则从机自动超时退出，检测超时期间无法操作设备。**

### 读取 主机-->从机 读取从机文件信息

```
           /------------/------------/------------/------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   /   数据包号  /    文件名   /  CRC16_L   /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x11 /2Bytes 00 00/   64Bytes  /    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/------------/
 /************C************R*************C***********/
PS：
小端模式：低8位在前
总帧长为：7Bytes
```

#### 回复读取 从机-->主机

```
           /------------/------------/------------/------------/------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   /   数据包号  /  数据长度  /   固件信息  /  CRC16_L  /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x11 /2Bytes 00 00/   2Bytes   /  128Bytes  /    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/------------/------------/
 /**************C******************R*******************C***********************/
PS：
小端模式：低8位在前
总帧长为：138Bytes
```



### 读取 主机-->从机 读取从机文件数据

- 主机通过发送读取文件数据起始帧

  - 从机回复文件数据流
  - 主机回复数据验证结果
  - 数据发送完毕？从机发送结束帧，主机应答OK。

  

主机发送读取文件数据流起始帧

```
           /------------/------------/------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   /   数据包号  /  CRC16_L   /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x11 /2Bytes FF FF/    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/
 /************C************R*************C***********/
PS：
小端模式：低8位在前
总帧长为：8Bytes
```

#### 回复读取 从机-->主机

```
           /------------/------------/------------/------------/------------/------------/------------/-----------/
         /    帧头    /   帧类型    /   功能码   /   数据包号  /  数据长度  /  固件数据  /   CRC16_L  /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/------------/
     /   2Bytes   /    1Byte   / 1Byte 0x11 /   2Bytes   /   2Bytes   /     ...    /    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/------------/------------/
 /**************C******************R*******************C***********************/
PS：
小端模式：低8位在前
数据包号：起始从1开始
数据长度：可以是128或者1024
固件数据：本包固件数据
帧长最小为：138Bytes
帧长最大为：1034Bytes
```

#### 主机回复收到数据验证正确 主机-->从机

```
           /------------/------------/------------/------------/
         /    帧头    /   帧类型    /   功能码   / ACK RESULT /
       /------------/------------/------------/------------/
     /   2Bytes   /    1Byte   /    1Byte   /   1Bytes   /
   /------------/------------/------------/------------/
PS：
帧长固定为：5Bytes 
ACK RESULT：1Byte 16进制0x02
```

#### 从机发送结束帧 从机-->主机

```
           /------------/------------/------------/-------------/-------------/-------------/--------------/
         /    帧头    /   帧类型    /   功能码   /   数据包号   /   数据长度   /   CRC16_L   /    CRC16_H   /
       /------------/------------/------------/--------------/--------------/-------------/--------------/
     /   2Bytes   /   1Byte    / 1Byte 0x11 / 2Bytes FF FF / 2Bytes 00 00  /     1Byte   /     1Byte    /
   /------------/------------/------------/--------------/----------------/-------------/--------------/
 /**************C******************R*******************C**********/
PS：
小端模式：低8位在前
总帧长为：10Bytes
```



## CRC计算公式

```c
/**
 * @brief modbus CRC计算
 * 
 * @param Data 
 * @param GenPoly 多项式
 * @param CrcData 
 * @return uint16_t 
 */
static uint16_t modbus_crc_cal(uint16_t Data ,uint16_t GenPoly ,uint16_t CrcData)
{
	uint16_t TmpI;
	Data *= 2;
	for(TmpI = 8; TmpI > 0; TmpI--) 
  {
		Data = Data / 2;
		if ((Data ^ CrcData) & 1)
			CrcData = (CrcData / 2) ^ GenPoly;
		else
			CrcData /= 2;
	}
	return CrcData;
}

/**
 * @brief modbusCRC计算
 * 
 * @param data 带入CRC计算的数据起始
 * @param data_len 带入CRC计算的数据长度
 * @return uint16_t 
 */
uint16_t modbus_crc_return(uint8_t *data, uint16_t data_len)
{
	uint16_t temp;
	uint16_t crc_ret = 0xFFFF;
	for (temp = 0; temp < data_len; temp++)
	{
		crc_ret = modbus_crc_cal(data[temp], 0xA001, crc_ret);
	}
	return crc_ret;
}
```



# 备用Modbus协议

## 主机-->从机 通讯协议

### 写入 功能码 0x10

```
           /------------/------------/------------/------------/------------/------------/-----------/-----------/
         /    地址    /   功能码    / 寄存器地址  /  写入数量  /  数据长度  /   变长数据  /  CRC16_L  /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/------------/------------/
     /   1Bytes   / 1Byte 0x10 /   2Bytes   /   2Bytes   /    1Byte   /     ...    /    1Byte   /    1Byte    /
   /------------/------------/------------/------------/------------/------------/------------/--------------/
 /**************C******************R*******************C***********************/    
  PS:
  寄存器地址与写入数量：高八位在前
  写入数量：不为1时代表，对多个寄存器写操作（如寄存器地址为0x0001,写入数量为0x0002，数据长度应为0x04，变长数据0x00 0x01 0x00 0x02）
  		  代表写入0x0001数值到0x0001寄存器和0x0002数值写入到0x0002寄存器
  变长数据：每两个字节为一个寄存器数据
```
从机回复
```
           /------------/------------/------------/------------/------------/------------/
         /    地址    /   功能码    / 寄存器地址  /  写入数量  /  CRC16_L  /   CRC16_H   /
       /------------/------------/------------/------------/------------/-------------/
     /   1Bytes   / 1Byte 0x10 /   2Bytes   /   2Bytes   /    1Byte   /    1Byte    /
   /------------/------------/------------/------------/------------/-------------/
 /*************C************R************C************/  
```



### 读取 功能码 0x03

```
           /------------/------------/------------/------------/------------/------------/
         /    地址    /    功能码   / 寄存器地址  /  读取数量  /  CRC16_L   /   CRC16_H  /
       /------------/------------/------------/------------/------------/------------/
     /   1Bytes   / 1Byte 0x03 /   2Bytes   /   2Bytes   /    1Byte   /    1Byte   /
   /------------/------------/------------/------------/------------/------------/
 /**********C**************R*************C**********/    
 PS:寄存器地址与读取数量：高八位在前
```
从机回复
```
           /------------/------------/------------/------------/------------/------------/
         /    地址    /   功能码   /   数据长度  /   变长数据  /   CRC16_L  /   CRC16_H   /
       /------------/------------/------------/------------/------------/-------------/
     /   1Bytes   / 1Byte 0x10 /   1Bytes   /     ...    /    1Byte   /    1Byte    /
   /------------/------------/------------/------------/------------/-------------/
 /********C************R*************C***************/    
 PS:寄存器地址与读取数量：高八位在前
 数据长度：除2等于寄存器数量
 变长数据：每两个字节代表一个寄存器当前数据
```


| 字段     | 数值      | 描述             |
| -------- | --------- | ---------------- |
| 地址     | 0x01 | uint8 从机ID号 |
| 功能码   | 0x03/0x10          |      uint8 主机发起读写寄存器      |
| 寄存器地址 | 可变      | uint16 每个寄存器代表一个 |
| 变长数据 | 可变      | 依据请求寄存器数量        |

| 功能码 | 描述         |
| ------ | ------------ |
| 0x03   | 主机读取     |
| 0x10   | 主机写入     |

| 寄存器地址 | 描述                | 数值                                                         |
| ---------- | ------------------- | ------------------------------------------------------------ |
| 0x0000     | 启用算法功能        | 2Bytes长度：为1开启降噪、2开启EMD、3开启EMD_WDRC、4开启VOL、5开启AGC、6全部使能 |
| 0x0001     | 调节音量            |                                                              |
| 0x0002     | 调节EQ IMF参数      |                                                              |
| 0x0003     | 调节WDRC            |                                                              |
| 0x0004     | 调节AGC             |                                                              |
| 0x0005     | 调节RNN NOISE Level |                                                              |
|            |                     |                                                              |